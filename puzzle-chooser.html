<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Choose Puzzle</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:0; padding:16px; background:#f7f9fb; color:#111 }
    h1 { font-size:18px; margin:0 0 12px }
    .list { display:flex; flex-direction:column; gap:8px }
    .item { background:#fff; border-radius:8px; padding:12px 14px; box-shadow:0 1px 3px rgba(0,0,0,0.06); cursor:pointer; display:flex; align-items:center; justify-content:space-between }
    .item:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,0.08) }
    .date { font-weight:600 }
    .choose { font-size:13px; color:#666 }
    .empty { text-align:center; color:#666; margin-top:30px }
    .close { position:fixed; right:12px; top:8px; border:none; background:#eee; padding:6px 8px; border-radius:6px; cursor:pointer }
  </style>
</head>
<body>
  <button class="close" onclick="window.close()">Close</button>
  <h1>Select a puzzle</h1>
  <div id="list" class="list">Loading…</div>
  <div id="empty" class="empty" style="display:none">No puzzles found.</div>

  <script>
    // Attempt to enumerate files from the server directory `/encrypted/html/puzzles/`.
    // Works with servers that expose a directory index (HTML) or a JSON listing.
    async function loadList() {
      const container = document.getElementById('list');
      container.innerHTML = 'Loading…';
      try {
        const dirUrl = '/encrypted/html/puzzles/';
        const res = await fetch(dirUrl, { cache: 'no-store' });
        if (!res.ok) throw new Error('Directory not accessible');
        const ct = res.headers.get('content-type') || '';
        let names = [];

        if (ct.includes('application/json')) {
          // Server returned JSON array of filenames or objects
          const json = await res.json();
          if (Array.isArray(json)) {
            names = json.map(item => typeof item === 'string' ? item : (item.filename || item.name)).filter(n => n !== 'mini.json.encrypted');
          }
        } else {
          // Parse HTML directory index and extract anchor hrefs
          const text = await res.text();
          const doc = new DOMParser().parseFromString(text, 'text/html');
          const anchors = Array.from(doc.querySelectorAll('a'));
          names = anchors.map(a => {
            try {
              const filename = new URL(a.getAttribute('href'), res.url).pathname.split('/').pop();
              return filename === 'mini.json.encrypted' ? null : filename;
            } catch(e){
              return a.getAttribute('href');
            }
          }).filter(Boolean);
        }

        // Normalize: remove trailing '.encrypted' if present, keep only .json files
        const normalized = Array.from(new Set(names.map(n => {
          if (!n) return null;
          let s = n;
          if (s.endsWith('.encrypted')) s = s.slice(0, -'.encrypted'.length);
          return s;
        }).filter(Boolean))).filter(n => n.toLowerCase().endsWith('.json'));

        container.innerHTML = '';
        if (normalized.length === 0) {
          document.getElementById('empty').style.display = 'block';
          return;
        }

        normalized.sort((a,b)=>{
          // try to extract yyyy-mm-dd from names like mini_YYYY-MM-DD or mini-YYYY-MM-DD
          const da = (a.match(/(\d{4}-\d{2}-\d{2})/) || [null])[0];
          const db = (b.match(/(\d{4}-\d{2}-\d{2})/) || [null])[0];
          if (da && db) return db.localeCompare(da);
          if (da) return -1;
          if (db) return 1;
          return a.localeCompare(b);
        });

        normalized.forEach(name => {
          const div = document.createElement('div');
          div.className = 'item';
          // display date if present
          const dateMatch = (name.match(/(\d{4}-\d{2}-\d{2})/) || [null])[0];
          const dateText = dateMatch || name;
          div.innerHTML = `<div><div class="date">${dateText}</div><div class="choose">${name}</div></div><div>Choose</div>`;
          div.onclick = () => choose(name);
          container.appendChild(div);
        });

      } catch (err) {
        document.getElementById('list').style.display = 'none';
        const e = document.getElementById('empty');
        e.textContent = 'Could not list puzzles from server.';
        e.style.display = 'block';
        console.error(err);
      }
    }

    function choose(filename) {
      try {
        if (window.opener && window.opener.loadDecryptedWebsite) {
          window.opener.loadDecryptedWebsite('puzzles/' + filename);
        } else if (window.opener && window.opener.postMessage) {
          window.opener.postMessage({ type: 'choose-puzzle', filename }, '*');
        } else {
          console.warn('No opener to receive chosen filename');
        }
      } catch (e) {
        console.error(e);
      }
      window.close();
    }

    loadList();
  </script>
</body>
</html>
